
#!/bin/bash
set -e -x

source ~/.bashrc

setup_env() {
  export ENV_DIR="$PWD/${DEPLOYMENTS_DIR}/${ENVIRONMENT}/${BOSH_LITE_NAME}"
  export BOSH_DEPLOYMENT_DIR="$PWD/bosh-deployment"
  export GCP_CREDENTIALS_PATH="${ENV_DIR}/cf-diego.json"
  export BOSH_LITE_PRIVATE_KEY="$PWD/${DEPLOYMENTS_DIR}/${ENVIRONMENT}/keypair/dusts"
}

provision_bosh_lite() {
	bosh \
		create-env ${BOSH_DEPLOYMENT_DIR}/bosh.yml \
		--state ${ENV_DIR}/state.json \
		-o ${BOSH_DEPLOYMENT_DIR}/gcp/cpi.yml \
		-o ${BOSH_DEPLOYMENT_DIR}/bosh-lite.yml \
		-o ${BOSH_DEPLOYMENT_DIR}/bosh-lite-runc.yml \
		--vars-store ${ENV_DIR}/creds.yml \
		-v director_name=${BOSH_LITE_NAME} \
		-v internal_cidr=${BOSH_LITE_PRIVATE_CIDR} \
		-v internal_gw=${BOSH_LITE_PRIVATE_GATEWAY} \
		-v internal_ip=${BOSH_LITE_PRIVATE_IP} \
		-v zone=${GCP_ZONE} \
		-v network=${GCP_NETWORK_ID} \
		-v tags=["bosh-lite","${BOSH_LITE_NAME}"] \
		-v project_id=${GCP_PROJECT_ID} \
		-v subnetwork=${GCP_SUBNET_ID} \
		--var-file gcp_credentials_json=${GCP_CREDENTIALS_PATH} \
		--var-file private_key=${BOSH_LITE_PRIVATE_KEY}
		-o ${BOSH_DEPLOYMENT_DIR}/external-ip-not-recommended.yml \
		-v external_ip=${BOSH_LITE_EXTERNAL_IP}
}

commit_state_json() {
  git config user.email "cf-diego@pivotal.io"
  git config user.name "CI (Automated)"

  git add -A
  git commit -m "Update dusts deployment ${BOSH_LITE_NAME}"
}

main() {
  setup_env
  provision_bosh_lite
  commit_state_json
}

main
