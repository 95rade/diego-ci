#!/usr/bin/env bash

set -ex

if [["x${PRIVATE_KEY}" = "x" ]] > /dev/null 2>&1; then
  echo "You must supply an SSH key!"
  exit 1
fi

export MERGED_CF_DEPLOYMENT=$PWD/merged-cf-deployment

pushd ${PWD}/cf-deployment-develop
  echo "----- Set git identity"
  git config user.email "cf-diego@pivotal.io"
  git config user.name "CI (Automated)"

  echo -e "Host github.com\n\tStrictHostKeyChecking no\n" >> /etc/ssh/ssh_config

  git fetch origin "+refs/heads/*:refs/remotes/origin/*"
  git checkout -b release-candidate remotes/origin/release-candidate

  eval `ssh-agent -s`
  ssh-add <(echo "${PRIVATE_KEY}") > /dev/null 2>&1

  for i in $(git branch -a | grep -e "remotes/origin/diego-[0-9]\+" | sort -t '-' -k 2 -g); do

    merged_rc=`git branch release-candidate --contains $i | wc -l`
    merged_develop=`git branch develop --contains $i | wc -l`
    if [[ $merged_rc -eq 1 ]]; then
      branch_name=${i#remotes/origin}
      echo "Deleting branch ${branch_name}"
      git push origin --delete branch_name
    elif [[ $merged_develop -ne 1 ]]; then
      echo "----- Merging cf-deployment branch ${i}"
      git merge --no-edit $i
    fi
  done

  cp -r . $MERGED_CF_DEPLOYMENT
popd

